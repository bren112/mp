<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pagamento PIX</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

  * {
    box-sizing: border-box;
  }

  body {
    font-family: 'Fredoka One', cursive;
    background: url('https://i.imgur.com/UGd7OAR.jpg') repeat;
    background-size: cover;
    color: #3b1f00;
    margin: 30px auto;
    max-width: 460px;
    padding: 20px;
    border-radius: 12px;
    border: 4px dashed #ffcc00;
    background-color: rgba(255, 255, 255, 0.9);
  }

  h2 {
    color: #d40000;
    text-align: center;
    margin-bottom: 25px;
    text-shadow: 2px 2px #ffe400;
  }

  input, textarea, button {
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 15px;
    background-color: #fff8dc;
    color: #4b2e00;
    border: 2px solid #ff9900;
    border-radius: 8px;
    font-size: 16px;
  }

  input::placeholder, textarea::placeholder {
    color: #a05a00;
  }

  input:focus, textarea:focus {
    outline: none;
    border-color: #ffcc00;
    box-shadow: 0 0 5px #ffcc00;
  }

  button {
    background-color: #ff3300;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    border: none;
    transition: 0.3s ease;
  }

  button:hover {
    background-color: #ff9900;
    box-shadow: 0 0 10px #ffa500;
  }

  #resultado img {
    display: block;
    margin: 20px auto 10px;
    width: 180px;
    height: 180px;
    border: 4px solid #ff9900;
    border-radius: 12px;
  }

  #resultado p {
    font-weight: bold;
    margin-bottom: 6px;
  }

  #resultado textarea {
    resize: none;
    font-family: monospace;
    background-color: #fff;
    color: #4b2e00;
    border: 2px solid #ff9900;
  }

  #btn-copiar {
    background-color: #fff3cd;
    color: #4b2e00;
    border: 2px dashed #ff9900;
    font-weight: bold;
    padding: 10px 14px;
    border-radius: 6px;
  }

  #btn-copiar:hover {
    background-color: #ffe08a;
    color: #000;
  }

  #status {
    font-weight: bold;
    color: #d40000;
    margin-top: 20px;
    text-align: center;
    font-size: 18px;
  }

  a {
    text-decoration: none;
    color: #ff3300;
    font-weight: bold;
    display: block;
    text-align: center;
    margin: 10px 0;
    font-size: 18px;
    transition: color 0.3s ease;
  }

  a:hover {
    color: #ff9900;
    text-shadow: 0 0 5px #ffe400;
  }

  .link-image {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }

  .link-image img {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    border: 3px solid #ff9900;
  }

  #secret-input, #secret-links {
    display: none;
    margin-top: 10px;
  }

  #secret-phrase {
    text-align: justify;
    cursor: pointer;
    font-size: 16px;
    color: #6b3f00;
    background: #fff3cd;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ffcc00;
    margin-bottom: 20px;
  }

  @media screen and (max-width: 480px) {
    body {
      margin: 20px;
    }

    a {
      font-size: 20px;
    }
  }

  /* Bandeirinhas Juninas */
  body::before {
    content: '';
    display: block;
    height: 50px;
    background: url('https://i.imgur.com/vulv1Fl.png') repeat-x;
    background-size: contain;
    margin: -20px -20px 20px -20px;
  }
</style>

</head>
<body>
  <!-- Links secretos escondidos inicialmente -->
  <div id="secret-links">
    <a href="todos.html">üìÑ Ver Pagamentos Aprovados</a>
    <a href="adm.html">‚öôÔ∏è Alterar Valor</a>
  </div>

  <!-- Frase clic√°vel -->
  <h4 id="secret-phrase" style="text-align: justify; cursor: pointer;">
    üî•
    ‚Äúquem faz a festa s√£o voc√™s, obrigado mais uma vez, nos vemos em breve‚Ä¶‚Äù
  </h4>

  <!-- Input para digitar o c√≥digo secreto -->
  <input type="text" id="secret-input" placeholder="Digite o c√≥digo secreto" />

  <div class="link-image">
    <img src="./fundo.png" alt="Imagem PIX" />
  </div>

  <h2>üéâ Pagamento via PIX</h2>

  <input type="text" id="first_name" placeholder="Nome" />
  <input type="text" id="last_name" placeholder="Sobrenome" />
  <input type="text" id="cpf" placeholder="CPF" />
  <input type="text" id="cidade" placeholder="Cidade" />
  <input type="number" id="valor" disabled />
  <button onclick="gerarPix()">üåΩ Gerar PIX</button>

  <div id="resultado"></div>
  <p id="status"></p>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const baseUrl = "https://festfy.onrender.com";
    let paymentId = null;

    const SUPABASE_URL = "https://jrbpwisclowinultbehj.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyYnB3aXNjbG93aW51bHRiZWhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjU3NTc4NjMsImV4cCI6MjA0MTMzMzg2M30.dFbRcWi0v7zdiR58ZcuTNfMTzi_GKg_56VL1-UT2JYs";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function gerarPix() {
      const valor = parseFloat(document.getElementById("valor").value);
      const first_name = document.getElementById("first_name").value.trim();
      const last_name = document.getElementById("last_name").value.trim();
      const cpf = document.getElementById("cpf").value.trim();
      const cidade = document.getElementById("cidade").value.trim();
    
      if (!valor || !first_name || !cpf || !cidade) {
        alert("Preencha todos os campos obrigat√≥rios.");
        return;
      }
    
      // Mostra um texto de carregando
      document.getElementById("resultado").innerHTML = `
        <p style="text-align:center; color:#00ff88;">‚è≥ Gerando QR Code, por favor aguarde...</p>
      `;
    
      // Timer para fallback se demorar demais (20 segundos)
      const tempoLimite = setTimeout(() => {
        document.getElementById("resultado").innerHTML = `
          <p style="text-align:center; color:red;">‚ùå Tempo excedido. Por favor, preencha os campos novamente.</p>
        `;
        setTimeout(() => location.reload(), 2000); 
      }, 15000); 
    
      try {
        const response = await fetch(`${baseUrl}/pix`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ valor, first_name, last_name, cpf })
        });
    
        const data = await response.json();
    
        clearTimeout(tempoLimite); // Cancela o timeout se respondeu
    
        if (data.error) {
          alert("Erro: " + data.error);
          return;
        }
    
        paymentId = data.payment_id;
    
        document.getElementById("resultado").innerHTML = `
          <img src="data:image/png;base64,${data.qr_code_base64}" alt="QR Code PIX" />
          <p>C√≥digo Copia e Cola:</p>
          <textarea id="codigoPix" rows="3" readonly>${data.qr_code}</textarea>
          <button id="btn-copiar" onclick="copiarCodigo()">üìã Copiar C√≥digo</button>
        `;
        document.getElementById("status").innerText = "";
        checarStatus();
    
      } catch (err) {
        clearTimeout(tempoLimite);
        alert("Tente Novamente (AGR VAI üôè)");
        console.error(err);
      }
    }
    
    function copiarCodigo() {
      const codigo = document.getElementById("codigoPix");
      codigo.select();
      codigo.setSelectionRange(0, 99999);
      document.execCommand("copy");
      alert("C√≥digo copiado!");
    }

    async function salvarPagamentoNoBanco() {
      const first_name = document.getElementById("first_name").value.trim();
      const last_name = document.getElementById("last_name").value.trim();
      const cpf = document.getElementById("cpf").value.trim();
      const cidade = document.getElementById("cidade").value.trim();
      const valor = parseFloat(document.getElementById("valor").value);
    
      // Verifica se o CPF j√° est√° salvo
      const { data: existing, error: selectError } = await supabaseClient
        .from("pagamentos_pix")
        .select("id")
        .eq("cpf", cpf);
    
      if (selectError) {
        console.error("Erro ao verificar CPF:", selectError);
        alert("Erro ao verificar CPF .");
        return;
      }
    
      if (existing.length > 0) {
        alert("Este CPF j√° foi utilizado para um pagamento.");
        return;
      }
    
      // CPF n√£o existe, pode salvar
      const { error } = await supabaseClient
        .from("pagamentos_pix")
        .insert([{
          first_name,
          last_name,
          cpf,
          valor,
          valor_pago: valor,
          cidade,
          payment_id: paymentId,
          created_at: new Date().toISOString()
        }]);
    
      if (error) {
        console.error("Erro ao salvar no Supabase:", error);
        alert("Erro 2 mande essa mesnagem pro adm Urgentemente!.");
      }
    }
    
    function checarStatus() {
  if (!paymentId) return;
  const interval = setInterval(() => {
    fetch(`${baseUrl}/status/${paymentId}`)
      .then(res => res.json())
      .then(async data => {
        if (data.status === "approved") {
          clearInterval(interval);
          await salvarPagamentoNoBanco(); // s√≥ salva aqui quando aprovado

          Swal.fire({
            icon: 'success',
            title: 'Pagamento Aprovado!',
            text: 'Obrigado! Seu pagamento foi confirmado com sucesso.',
            background: '#0f0f0f',
            color: '#00ff88',
            confirmButtonColor: '#00ff88',
            confirmButtonText: 'OK'
          }).then(() => {
            // Aqui substitu√≠mos todo o body pelo bot√£o para o link
            document.body.innerHTML = `
              <div style="display:flex; justify-content:center; align-items:center; height:100vh; background:#0f0f0f; margin:0;">
                <button 
                  id="link-button" 
                  style="
                    padding: 15px 30px; 
                    font-size: 18px; 
                    background-color: #00ff88; 
                    border:none; 
                    border-radius: 8px; 
                    cursor: pointer; 
                    font-family: 'Orbitron', sans-serif;
                    color: #000;
                    box-shadow: 0 0 12px #00ff88;
                    transition: background-color 0.3s ease;
                  "
                  onmouseover="this.style.backgroundColor='#00ffaa'"
                  onmouseout="this.style.backgroundColor='#00ff88'"
                >
                  Ir para o Link
                </button>
              </div>
            `;

            // Adiciona o evento para redirecionar ao clicar
            const btn = document.getElementById("link-button");
            btn.addEventListener("click", () => {
              // Coloque o link desejado aqui:
              window.location.href = "https://festfy.vercel.app/saber.html";
            });
          });

        } else {
          console.log("Status atual:", data.status);
        }
      })
      .catch(err => console.error("Erro ao verificar status:", err));
  }, 5000);
}

    async function carregarValorDoBanco() {
      const { data, error } = await supabaseClient
        .from("valor")
        .select("valor")
        .order("id", { ascending: false })
        .limit(1);

      if (!error && data.length > 0) {
        document.getElementById("valor").value = data[0].valor;
      } else {
        document.getElementById("valor").value = 3;
      }
    }

    carregarValorDoBanco();

    // --- Nova l√≥gica para o clique secreto e input de c√≥digo ---
    const phrase = document.getElementById("secret-phrase");
    const secretInput = document.getElementById("secret-input");
    const secretLinks = document.getElementById("secret-links");
    let clickCount = 0;

    phrase.addEventListener("click", () => {
      clickCount++;
      if (clickCount === 3) {
        secretInput.style.display = "block";
        secretInput.focus();
      }
    });

    secretInput.addEventListener("input", () => {
      const value = secretInput.value.trim();
      if (value === "zankaadm") {
        secretLinks.style.display = "block";
      } else {
        secretLinks.style.display = "none";
      }
    });
  </script>
</body>
</html>
